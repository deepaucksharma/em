---
import ContentLayout from '../../layouts/ContentLayout.astro';
import Breadcrumb from '../../components/ui/Breadcrumb.astro';
import Badge from '../../components/ui/Badge.astro';
import { getCapability } from '../../lib/data';
import { url } from '../../lib/url';
import careerData from '../../data/career-progression.json';

const career = careerData as { levels: any[] };

export function getStaticPaths() {
  return (careerData as { levels: any[] }).levels.map(level => ({
    params: { slug: level.slug },
  }));
}

const { slug } = Astro.params;
const level = career.levels.find(l => l.slug === slug)!;

const capExpectations = Object.entries(level.capabilityExpectations as Record<string, string>)
  .map(([id, expectation]) => ({
    capability: getCapability(id),
    expectation,
  }))
  .filter(c => c.capability);

const expectationColors: Record<string, { bg: string; text: string }> = {
  high: { bg: 'bg-green-100 dark:bg-green-900/30', text: 'text-green-700 dark:text-green-300' },
  medium: { bg: 'bg-yellow-100 dark:bg-yellow-900/30', text: 'text-yellow-700 dark:text-yellow-300' },
  low: { bg: 'bg-gray-100 dark:bg-gray-700', text: 'text-gray-600 dark:text-gray-400' },
};
---

<ContentLayout title={level.title} description={level.scope} currentSlug={slug} showSidebar={false}>
  <div class="max-w-4xl mx-auto">
    <Breadcrumb items={[
      { label: 'Career Progression', href: url('/career-progression/') },
      { label: level.title },
    ]} />

    <div class="mb-8">
      <h1 class="text-3xl font-extrabold text-gray-900 dark:text-white tracking-tight mb-3">
        {level.title}
      </h1>
      <p class="text-lg text-gray-600 dark:text-gray-400">{level.scope}</p>
    </div>

    {/* Key Differences */}
    <section class="mb-10">
      <h2 class="section-heading">Key Differences</h2>
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
        {level.keyDifferences.map((diff: string) => (
          <div class="card flex items-start gap-3">
            <svg class="w-5 h-5 text-blue-500 mt-0.5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span class="text-sm text-gray-700 dark:text-gray-300">{diff}</span>
          </div>
        ))}
      </div>
    </section>

    {/* Capability Expectations */}
    <section class="mb-10">
      <h2 class="section-heading">Capability Expectations</h2>
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
        {capExpectations.map(({ capability: cap, expectation }) => cap && (
          <a href={url(`/capabilities/${cap.slug}/`)} class="flex items-center justify-between p-3 rounded-lg border border-gray-200 dark:border-gray-700 hover:border-blue-300 dark:hover:border-blue-700 transition-colors">
            <div class="flex items-center gap-2">
              <Badge text={cap.domain} variant="domain" domain={cap.domain} />
              <span class="text-sm text-gray-700 dark:text-gray-300">{cap.id}: {cap.name}</span>
            </div>
            <span class:list={[
              'text-xs font-medium px-2 py-0.5 rounded-full',
              expectationColors[expectation]?.bg,
              expectationColors[expectation]?.text,
            ]}>
              {expectation}
            </span>
          </a>
        ))}
      </div>
    </section>

    {/* Promotion Blockers */}
    <section class="mb-10">
      <h2 class="section-heading">Promotion Blockers</h2>
      <div class="bg-red-50 dark:bg-red-950/20 rounded-xl border border-red-200 dark:border-red-800 p-4">
        <ul class="space-y-2">
          {level.promotionBlockers.map((blocker: string) => (
            <li class="text-sm text-red-700 dark:text-red-300 flex items-start gap-2">
              <svg class="w-4 h-4 mt-0.5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z" />
              </svg>
              {blocker}
            </li>
          ))}
        </ul>
      </div>
    </section>

    {/* Transition Signals */}
    <section class="mb-10">
      <h2 class="section-heading">Transition Signals</h2>
      <div class="bg-green-50 dark:bg-green-950/20 rounded-xl border border-green-200 dark:border-green-800 p-4">
        <p class="text-sm text-green-700 dark:text-green-300 mb-3">Signs you're ready for the next level:</p>
        <ul class="space-y-2">
          {level.transitionSignals.map((signal: string) => (
            <li class="text-sm text-green-700 dark:text-green-300 flex items-start gap-2">
              <svg class="w-4 h-4 mt-0.5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
              </svg>
              {signal}
            </li>
          ))}
        </ul>
      </div>
    </section>
  </div>
</ContentLayout>
