---
import ContentLayout from '../../layouts/ContentLayout.astro';
import Breadcrumb from '../../components/ui/Breadcrumb.astro';
import Badge from '../../components/ui/Badge.astro';
import ObservableCard from '../../components/cards/ObservableCard.astro';
import AntiPatternCard from '../../components/cards/AntiPatternCard.astro';
import PlaybookCard from '../../components/cards/PlaybookCard.astro';
import CapabilityCard from '../../components/cards/CapabilityCard.astro';
import MetricCard from '../../components/cards/MetricCard.astro';
import {
  capabilities,
  getCapability,
  getCoverage,
  getObservablesForCapability,
  getAntiPatternsForCapability,
  getPlaybooksForCapability,
  getRubricAnchorsForCapability,
  getRelatedCapabilities,
  getLearningPathway,
  getMeasurementGuidance,
  getInterviewQuestionsForCapability,
  getMetricsForCapability,
} from '../../lib/data';
import { formatPercent } from '../../lib/utils';
import { url } from '../../lib/url';

export function getStaticPaths() {
  return capabilities.map(cap => ({
    params: { slug: cap.slug },
  }));
}

const { slug } = Astro.params;
const cap = getCapability(slug!)!;
const cov = getCoverage(cap.id);
const observables = getObservablesForCapability(cap.id);
const aps = getAntiPatternsForCapability(cap.id);
const pbs = getPlaybooksForCapability(cap.id);
const rubrics = getRubricAnchorsForCapability(cap.id);
const related = getRelatedCapabilities(cap.id);
const pathway = getLearningPathway(cap.id);
const measurement = getMeasurementGuidance(cap.id);
const iqCount = getInterviewQuestionsForCapability(cap.id).length;
const relatedMetrics = getMetricsForCapability(cap.id);
---

<ContentLayout title={`${cap.id}: ${cap.name}`} description={cap.description} currentSlug={cap.slug}>
  <Breadcrumb items={[
    { label: 'Capabilities', href: url('/capabilities/') },
    { label: `${cap.id}: ${cap.name}` },
  ]} />

  <!-- Header -->
  <div class="mb-8">
    <div class="flex items-center gap-3 mb-3 flex-wrap">
      <Badge text={cap.domain} variant="domain" domain={cap.domain} />
      <span class="text-sm text-gray-500 dark:text-gray-400">{observables.length} observables</span>
      {cov && <span class="text-sm text-gray-500 dark:text-gray-400" title="Percentage of primary sub-topics covered by observables">{formatPercent(cov.coveragePercent)} coverage</span>}
    </div>
    <h1 class="text-3xl font-extrabold text-gray-900 dark:text-white tracking-tight mb-3">
      {cap.name}
    </h1>
    <p class="text-lg text-gray-600 dark:text-gray-400">{cap.description}</p>
  </div>

  <!-- Rubric Progression -->
  {rubrics.length > 0 && (
    <section class="mb-10">
      <h2 class="section-heading">Rubric Progression</h2>
      {rubrics.map((rubric, i) => (
        <div class:list={['mb-6', rubrics.length > 1 && 'pt-4']}>
          <h3 class="text-sm font-semibold text-gray-500 dark:text-gray-400 mb-3 uppercase tracking-wider">
            {rubric.sourceTopic}
          </h3>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="rounded-xl border border-gray-200 dark:border-gray-700 p-4 bg-gray-50 dark:bg-gray-800/50">
              <h4 class="text-sm font-semibold text-gray-500 dark:text-gray-400 mb-2">
                <span class="inline-flex items-center justify-center w-4 h-4 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-300 text-[9px] font-bold mr-1">1</span>
                Developing
              </h4>
              <p class="text-sm text-gray-700 dark:text-gray-300">{rubric.level1Developing}</p>
            </div>
            <div class="rounded-xl border border-blue-200 dark:border-blue-800 p-4 bg-blue-50 dark:bg-blue-950/20">
              <h4 class="text-sm font-semibold text-blue-600 dark:text-blue-400 mb-2">
                <span class="inline-flex items-center justify-center w-4 h-4 rounded-full bg-blue-200 dark:bg-blue-900 text-blue-700 dark:text-blue-300 text-[9px] font-bold mr-1">3</span>
                Competent
              </h4>
              <p class="text-sm text-blue-700 dark:text-blue-300">{rubric.level3Competent}</p>
            </div>
            <div class="rounded-xl border border-green-200 dark:border-green-800 p-4 bg-green-50 dark:bg-green-950/20">
              <h4 class="text-sm font-semibold text-green-600 dark:text-green-400 mb-2">
                <span class="inline-flex items-center justify-center w-4 h-4 rounded-full bg-green-200 dark:bg-green-900 text-green-700 dark:text-green-300 text-[9px] font-bold mr-1">5</span>
                Advanced
              </h4>
              <p class="text-sm text-green-700 dark:text-green-300">{rubric.level5Advanced}</p>
            </div>
          </div>
          <details class="mt-3">
            <summary class="text-xs font-medium text-gray-500 dark:text-gray-400 cursor-pointer hover:text-gray-700 dark:hover:text-gray-300 select-none">
              Show progression indicators (L2 Emerging, L4 Distinguished)
            </summary>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-3">
              <div class="rounded-xl border border-dashed border-amber-200 dark:border-amber-800 p-4 bg-amber-50 dark:bg-amber-950/20">
                <h4 class="text-sm font-semibold text-amber-600 dark:text-amber-400 mb-2">
                  <span class="inline-flex items-center justify-center w-4 h-4 rounded-full bg-amber-200 dark:bg-amber-900 text-amber-700 dark:text-amber-300 text-[9px] font-bold mr-1">2</span>
                  Emerging
                </h4>
                <p class="text-sm text-amber-800 dark:text-amber-300">{rubric.level2Emerging}</p>
              </div>
              <div class="rounded-xl border border-dashed border-purple-200 dark:border-purple-800 p-4 bg-purple-50 dark:bg-purple-950/20">
                <h4 class="text-sm font-semibold text-purple-600 dark:text-purple-400 mb-2">
                  <span class="inline-flex items-center justify-center w-4 h-4 rounded-full bg-purple-200 dark:bg-purple-900 text-purple-700 dark:text-purple-300 text-[9px] font-bold mr-1">4</span>
                  Distinguished
                </h4>
                <p class="text-sm text-purple-800 dark:text-purple-300">{rubric.level4Distinguished}</p>
              </div>
            </div>
          </details>
        </div>
      ))}
    </section>
  )}

  <!-- Observables -->
  <section class="mb-10">
    <h2 class="section-heading">Observables ({observables.length})</h2>
    <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">Each observable carries a weight (visible when expanded) indicating its relative importance within this capability. Weights sum to approximately 1.0 and reflect how frequently the behavior surfaces in calibration discussions, incident reviews, and promotion assessments.</p>
    <div class="space-y-3">
      {observables.map(obs => (
        <ObservableCard observable={obs} />
      ))}
    </div>
  </section>

  <!-- Related Anti-Patterns -->
  {aps.length > 0 && (
    <section class="mb-10">
      <h2 class="section-heading">Related Anti-Patterns</h2>
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        {aps.map(ap => (
          <AntiPatternCard antiPattern={ap} />
        ))}
      </div>
    </section>
  )}

  <!-- Related Playbooks -->
  {pbs.length > 0 && (
    <section class="mb-10">
      <h2 class="section-heading">Related Playbooks</h2>
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        {pbs.map(pb => (
          <PlaybookCard playbook={pb} />
        ))}
      </div>
    </section>
  )}

  <!-- Learning Pathway -->
  {pathway && (
    <section class="mb-10">
      <h2 class="section-heading">Learning Pathway</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <h3 class="text-sm font-semibold text-gray-500 dark:text-gray-400 mb-3 uppercase tracking-wider">Foundational</h3>
          <div class="space-y-2">
            {pathway.foundational.map(item => (
              <div class="rounded-lg border border-gray-200 dark:border-gray-700 p-3 bg-gray-50 dark:bg-gray-800/50">
                <div class="flex items-center gap-2 mb-1">
                  <span class="text-xs font-medium text-gray-400 uppercase">{item.type}</span>
                </div>
                {item.url ? (
                  <a href={item.url} target="_blank" rel="noopener" class="text-sm font-medium text-gray-700 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400">{item.title}</a>
                ) : (
                  <p class="text-sm font-medium text-gray-700 dark:text-gray-300">{item.title}</p>
                )}
                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1 line-clamp-2">{item.description}</p>
              </div>
            ))}
          </div>
        </div>
        <div>
          <h3 class="text-sm font-semibold text-blue-600 dark:text-blue-400 mb-3 uppercase tracking-wider">Practical</h3>
          <div class="space-y-2">
            {pathway.practical.map(item => (
              <div class="rounded-lg border border-blue-200 dark:border-blue-800 p-3 bg-blue-50 dark:bg-blue-950/20">
                <div class="flex items-center gap-2 mb-1">
                  <span class="text-xs font-medium text-blue-400 uppercase">{item.type}</span>
                </div>
                {item.url ? (
                  <a href={item.url} target="_blank" rel="noopener" class="text-sm font-medium text-blue-700 dark:text-blue-300 hover:text-blue-800 dark:hover:text-blue-200">{item.title}</a>
                ) : (
                  <p class="text-sm font-medium text-blue-700 dark:text-blue-300">{item.title}</p>
                )}
                <p class="text-xs text-blue-500 dark:text-blue-400 mt-1 line-clamp-2">{item.description}</p>
              </div>
            ))}
          </div>
        </div>
        <div>
          <h3 class="text-sm font-semibold text-green-600 dark:text-green-400 mb-3 uppercase tracking-wider">Advanced</h3>
          <div class="space-y-2">
            {pathway.advanced.map(item => (
              <div class="rounded-lg border border-green-200 dark:border-green-800 p-3 bg-green-50 dark:bg-green-950/20">
                <div class="flex items-center gap-2 mb-1">
                  <span class="text-xs font-medium text-green-400 uppercase">{item.type}</span>
                </div>
                {item.url ? (
                  <a href={item.url} target="_blank" rel="noopener" class="text-sm font-medium text-green-700 dark:text-green-300 hover:text-green-800 dark:hover:text-green-200">{item.title}</a>
                ) : (
                  <p class="text-sm font-medium text-green-700 dark:text-green-300">{item.title}</p>
                )}
                <p class="text-xs text-green-500 dark:text-green-400 mt-1 line-clamp-2">{item.description}</p>
              </div>
            ))}
          </div>
        </div>
      </div>
      <p class="text-sm text-gray-500 dark:text-gray-400 mt-3">
        <a href={url("/learning-pathways/")} class="text-blue-600 dark:text-blue-400 hover:underline">View all learning pathways &rarr;</a>
      </p>
    </section>
  )}

  <!-- Measurement Guidance -->
  {measurement && (
    <section class="mb-10">
      <h2 class="section-heading">Measurement Guidance</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="rounded-xl border border-green-200 dark:border-green-800 p-4 bg-green-50 dark:bg-green-950/20">
          <h3 class="text-sm font-semibold text-green-600 dark:text-green-400 mb-3">Leading Indicators</h3>
          <ul class="space-y-2">
            {measurement.leadingIndicators.map(ind => (
              <li class="text-sm text-green-700 dark:text-green-300 flex items-start gap-2">
                <svg class="w-4 h-4 mt-0.5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                </svg>
                {ind}
              </li>
            ))}
          </ul>
        </div>
        <div class="rounded-xl border border-blue-200 dark:border-blue-800 p-4 bg-blue-50 dark:bg-blue-950/20">
          <h3 class="text-sm font-semibold text-blue-600 dark:text-blue-400 mb-3">Lagging Indicators</h3>
          <ul class="space-y-2">
            {measurement.laggingIndicators.map(ind => (
              <li class="text-sm text-blue-700 dark:text-blue-300 flex items-start gap-2">
                <svg class="w-4 h-4 mt-0.5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                </svg>
                {ind}
              </li>
            ))}
          </ul>
        </div>
        <div class="rounded-xl border border-red-200 dark:border-red-800 p-4 bg-red-50 dark:bg-red-950/20">
          <h3 class="text-sm font-semibold text-red-600 dark:text-red-400 mb-3">Measurement Anti-Patterns</h3>
          <ul class="space-y-2">
            {measurement.measurementAntiPatterns.map(ap => (
              <li class="text-sm text-red-700 dark:text-red-300 flex items-start gap-2">
                <svg class="w-4 h-4 mt-0.5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z" />
                </svg>
                {ap}
              </li>
            ))}
          </ul>
        </div>
      </div>
      <div class="flex items-center gap-4 mt-3 text-sm text-gray-500 dark:text-gray-400">
        <span>Suggested cadence: <strong class="text-gray-700 dark:text-gray-300">{measurement.suggestedCadence}</strong></span>
        <a href={url("/measurement-guide/")} class="text-blue-600 dark:text-blue-400 hover:underline">Full measurement guide &rarr;</a>
      </div>
    </section>
  )}

  <!-- Related Metrics -->
  {relatedMetrics.length > 0 && (
    <section class="mb-10">
      <h2 class="section-heading">Related Metrics</h2>
      <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">Specific named metrics from the metrics framework that relate to this capability.</p>
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
        {relatedMetrics.map(m => (
          <MetricCard metric={m} compact />
        ))}
      </div>
      <p class="text-sm text-gray-500 dark:text-gray-400 mt-3">
        <a href={url("/metrics/")} class="text-blue-600 dark:text-blue-400 hover:underline">View all metrics &rarr;</a>
      </p>
    </section>
  )}

  <!-- Interview Questions -->
  {iqCount > 0 && (
    <section class="mb-10">
      <h2 class="section-heading">
        Interview Questions
        <span class="ml-2 text-sm font-normal text-gray-500 dark:text-gray-400">({iqCount} questions)</span>
      </h2>
      <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">
        Behavioral, situational, and technical interview questions mapped to this capability.
      </p>
      <a href={url("/interview-questions/")} class="inline-flex items-center gap-2 px-4 py-2 rounded-lg border border-blue-200 dark:border-blue-800 bg-blue-50 dark:bg-blue-950/20 text-sm font-medium text-blue-700 dark:text-blue-300 hover:bg-blue-100 dark:hover:bg-blue-900/30 transition-colors">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        View interview questions &rarr;
      </a>
    </section>
  )}

  <!-- Related Capabilities -->
  {related.length > 0 && (
    <section class="mb-10">
      <h2 class="section-heading">Related Capabilities</h2>
      <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">Connected via shared observables and crosswalk mappings.</p>
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        {related.map(rc => (
          <CapabilityCard capability={rc} />
        ))}
      </div>
    </section>
  )}
</ContentLayout>
