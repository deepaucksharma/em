---
import ContentLayout from '../../layouts/ContentLayout.astro';
import Breadcrumb from '../../components/ui/Breadcrumb.astro';
import Badge from '../../components/ui/Badge.astro';
import { antiPatterns, getCapability, observables, capabilities } from '../../lib/data';
import { url } from '../../lib/url';

export function getStaticPaths() {
  return antiPatterns.map(ap => ({
    params: { slug: ap.slug },
  }));
}

const { slug } = Astro.params;
const ap = antiPatterns.find(a => a.slug === slug)!;
const cap = getCapability(ap.capabilityId);
const relatedObs = observables.filter(o => ap.observableIds.includes(o.id));
---

<ContentLayout title={`${ap.id}: ${ap.name}`} description={ap.shortDesc} showSidebar={false}>
  <Breadcrumb items={[
    { label: 'Anti-Patterns', href: url('/anti-patterns/') },
    { label: `${ap.id}: ${ap.name}` },
  ]} />

  <div class="max-w-3xl">
    <div class="flex items-center gap-3 mb-4 flex-wrap">
      {cap && <Badge text={cap.domain} variant="domain" domain={cap.domain} />}
      <span class="text-sm font-mono text-gray-400 dark:text-gray-500">{ap.id}</span>
      {cap && (
        <a href={url(`/capabilities/${cap.slug}/`)} class="text-sm text-blue-600 hover:text-blue-700 dark:text-blue-400">
          {cap.id}: {cap.name}
        </a>
      )}
    </div>

    <h1 class="text-3xl font-extrabold text-gray-900 dark:text-white tracking-tight mb-3">
      {ap.name}
    </h1>
    <p class="text-lg text-gray-600 dark:text-gray-400 mb-8">{ap.shortDesc}</p>

    {ap.warningSigns?.length > 0 && (
      <section class="mb-8">
        <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-3">Warning Signs</h2>
        <div class="bg-amber-50 dark:bg-amber-950/20 border border-amber-200 dark:border-amber-800 rounded-xl p-5">
          <ul class="space-y-2 text-amber-800 dark:text-amber-300">
            {ap.warningSigns.map((sign: string) => (
              <li class="flex items-start gap-2">
                <span class="mt-1.5 h-1.5 w-1.5 rounded-full bg-amber-400 dark:bg-amber-500 shrink-0" />
                <span>{sign}</span>
              </li>
            ))}
          </ul>
        </div>
      </section>
    )}

    {ap.impact && (
      <section class="mb-8">
        <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-3">Impact</h2>
        <div class="bg-red-50 dark:bg-red-950/20 border border-red-200 dark:border-red-800 rounded-xl p-5">
          <p class="text-red-800 dark:text-red-300 whitespace-pre-line">{ap.impact}</p>
        </div>
      </section>
    )}

    {ap.recoveryActions?.length > 0 && (
      <section class="mb-8">
        <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-3">Recovery Actions</h2>
        <div class="bg-green-50 dark:bg-green-950/20 border border-green-200 dark:border-green-800 rounded-xl p-5">
          <ul class="space-y-2 text-green-800 dark:text-green-300">
            {ap.recoveryActions.map((action: string) => (
              <li class="flex items-start gap-2">
                <span class="mt-1.5 h-1.5 w-1.5 rounded-full bg-green-400 dark:bg-green-500 shrink-0" />
                <span>{action}</span>
              </li>
            ))}
          </ul>
        </div>
      </section>
    )}

    {relatedObs.length > 0 && (
      <section class="mb-8">
        <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-3">Related Observables</h2>
        <ul class="space-y-2">
          {relatedObs.map(obs => (
            <li>
              <a
                href={(() => { const obsCap = capabilities.find(c => c.id === obs.capabilityId); return obsCap ? url(`/capabilities/${obsCap.slug}/#${obs.id.toLowerCase()}`) : '#'; })()}
                class="flex items-start gap-2 p-3 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors"
              >
                <span class="font-mono text-xs text-gray-400 dark:text-gray-500 mt-0.5 shrink-0">{obs.id}</span>
                <span class="text-sm text-gray-700 dark:text-gray-300">{obs.shortText}</span>
              </a>
            </li>
          ))}
        </ul>
      </section>
    )}

    {cap && (
      <section class="mb-8">
        <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-3">Related Capability</h2>
        <a href={url(`/capabilities/${cap.slug}/`)} class="card block group">
          <Badge text={cap.domain} variant="domain" domain={cap.domain} />
          <h3 class="text-lg font-semibold text-gray-900 dark:text-white group-hover:text-blue-600 dark:group-hover:text-blue-400 mt-2">
            {cap.id}: {cap.name}
          </h3>
          <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">{cap.description}</p>
        </a>
      </section>
    )}
  </div>
</ContentLayout>
