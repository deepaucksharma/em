---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Breadcrumb from '../../components/ui/Breadcrumb.astro';
import CalibrationLanguageCard from '../../components/cards/CalibrationLanguageCard.astro';
import { calibrationLanguage } from '../../lib/data';
import { url } from '../../lib/url';

const contexts = [...new Set(calibrationLanguage.map(cl => cl.context))];
const roles = [...new Set(calibrationLanguage.map(cl => cl.role))];

const contextLabels: Record<string, string> = {
  'sprint-review': 'Sprint Review',
  'qbr': 'QBR',
  'promo-packet': 'Promo Packet',
  'budget': 'Budget',
  'vp-report': 'VP Report',
  'board': 'Board',
  'incident-postmortem': 'Incident Postmortem',
  '1-on-1': '1-on-1',
};
---

<BaseLayout title="Calibration Language Bank" description="28 ready-to-use templates for communicating metrics in QBRs, promo packets, sprint reviews, and VP reports.">
  <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <Breadcrumb items={[
      { label: 'Metrics', href: url('/metrics/') },
      { label: 'Calibration Language' },
    ]} />

    <div class="mb-10">
      <h1 class="text-3xl font-extrabold text-gray-900 dark:text-white tracking-tight mb-3">
        Calibration Language Bank
      </h1>
      <p class="text-lg text-gray-600 dark:text-gray-400">
        Ready-to-use templates for communicating metrics data in different contexts.
        Each template includes placeholder variables, usage guidance, and anti-pattern warnings.
      </p>
    </div>

    <!-- Filters -->
    <div class="flex flex-wrap gap-4 mb-8">
      <div>
        <label class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-2 block">Context</label>
        <div class="flex flex-wrap gap-2" id="context-filters">
          <button class="context-filter-btn active px-3 py-1.5 rounded-lg text-sm font-medium bg-blue-50 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300" data-context="all">All</button>
          {contexts.map(ctx => (
            <button class="context-filter-btn px-3 py-1.5 rounded-lg text-sm font-medium text-gray-500 hover:bg-gray-100 dark:text-gray-400 dark:hover:bg-gray-800" data-context={ctx}>
              {contextLabels[ctx] || ctx}
            </button>
          ))}
        </div>
      </div>
      <div>
        <label class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-2 block">Role</label>
        <div class="flex flex-wrap gap-2" id="role-filters">
          <button class="role-filter-btn active px-3 py-1.5 rounded-lg text-sm font-medium bg-blue-50 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300" data-role="all">All</button>
          {roles.map(role => (
            <button class="role-filter-btn px-3 py-1.5 rounded-lg text-sm font-medium text-gray-500 hover:bg-gray-100 dark:text-gray-400 dark:hover:bg-gray-800" data-role={role}>
              {role.toUpperCase()}
            </button>
          ))}
        </div>
      </div>
    </div>

    <!-- Cards -->
    <div class="space-y-4" id="language-cards">
      {calibrationLanguage.map(entry => (
        <div class="language-card" data-context={entry.context} data-role={entry.role}>
          <CalibrationLanguageCard entry={entry} />
        </div>
      ))}
    </div>
  </div>
</BaseLayout>

<script>
  function setupFilters(containerSelector: string, btnSelector: string, dataAttr: string) {
    const buttons = document.querySelectorAll(btnSelector);
    buttons.forEach(btn => {
      btn.addEventListener('click', () => {
        buttons.forEach(b => {
          b.classList.remove('active', 'bg-blue-50', 'text-blue-700', 'dark:bg-blue-900/30', 'dark:text-blue-300');
          b.classList.add('text-gray-500', 'hover:bg-gray-100', 'dark:text-gray-400', 'dark:hover:bg-gray-800');
        });
        btn.classList.add('active', 'bg-blue-50', 'text-blue-700', 'dark:bg-blue-900/30', 'dark:text-blue-300');
        btn.classList.remove('text-gray-500', 'hover:bg-gray-100', 'dark:text-gray-400', 'dark:hover:bg-gray-800');
        applyFilters();
      });
    });
  }

  function applyFilters() {
    const activeContext = document.querySelector('.context-filter-btn.active') as HTMLElement | null;
    const activeRole = document.querySelector('.role-filter-btn.active') as HTMLElement | null;
    const context = activeContext?.dataset.context || 'all';
    const role = activeRole?.dataset.role || 'all';

    document.querySelectorAll('.language-card').forEach(card => {
      const el = card as HTMLElement;
      const matchContext = context === 'all' || el.dataset.context === context;
      const matchRole = role === 'all' || el.dataset.role === role;
      el.style.display = matchContext && matchRole ? '' : 'none';
    });
  }

  setupFilters('#context-filters', '.context-filter-btn', 'context');
  setupFilters('#role-filters', '.role-filter-btn', 'role');
</script>
