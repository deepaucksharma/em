---
import BaseLayout from '../layouts/BaseLayout.astro';
import Breadcrumb from '../components/ui/Breadcrumb.astro';
import Badge from '../components/ui/Badge.astro';
import { calibrationSignals, capabilities, getCapability } from '../lib/data';
import { getDomainColor } from '../lib/utils';
import { url } from '../lib/url';

const signalTypes = [...new Set(calibrationSignals.map(s => s.signalType))].sort();

// Group by capability
const signalsByCapability = capabilities.map(cap => ({
  capability: cap,
  signals: calibrationSignals.filter(s => s.capabilityId === cap.id),
})).filter(g => g.signals.length > 0);
---

<BaseLayout title="Calibration Signals" description={`${calibrationSignals.length} calibration signals for promo packets, reviews, and career conversations.`}>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <Breadcrumb items={[{ label: 'Calibration Signals' }]} />

    <div class="mb-8">
      <h1 class="text-3xl font-extrabold text-gray-900 dark:text-white tracking-tight mb-2">Calibration Signals</h1>
      <p class="text-lg text-gray-600 dark:text-gray-400">
        {calibrationSignals.length} signals across {signalTypes.length} types — language and evidence for promo packets, calibration sessions, and performance reviews.
      </p>
    </div>

    <!-- Signal type filters -->
    <div class="flex flex-wrap gap-2 mb-8" id="signal-filters">
      <button
        class="signal-filter-btn badge bg-blue-100 text-blue-700 dark:bg-blue-900/40 dark:text-blue-300 cursor-pointer border border-blue-300 dark:border-blue-700"
        data-filter="all"
        role="button"
        aria-pressed="true"
      >
        All ({calibrationSignals.length})
      </button>
      {signalTypes.map(type => {
        const count = calibrationSignals.filter(s => s.signalType === type).length;
        return (
          <button
            class="signal-filter-btn badge bg-gray-100 text-gray-700 dark:bg-gray-700 dark:text-gray-300 cursor-pointer border border-transparent hover:border-gray-300 dark:hover:border-gray-500 transition-colors"
            data-filter={type}
            role="button"
            aria-pressed="false"
          >
            {type} ({count})
          </button>
        );
      })}
    </div>

    <div class="space-y-8" id="signal-sections">
      {signalsByCapability.map(({ capability: cap, signals }) => (
        <section class="border border-gray-200 dark:border-gray-700 rounded-xl overflow-hidden signal-section">
          <div class:list={['px-6 py-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between', getDomainColor(cap.domain).bg]}>
            <div class="flex items-center gap-3">
              <Badge text={cap.domain} variant="domain" domain={cap.domain} />
              <a href={url(`/capabilities/${cap.slug}/`)} class="font-bold text-gray-900 dark:text-white hover:text-blue-600 dark:hover:text-blue-400">
                {cap.id}: {cap.name}
              </a>
            </div>
            <span class="text-sm text-gray-500 dark:text-gray-400 signal-count">{signals.length} signals</span>
          </div>

          <div class="divide-y divide-gray-100 dark:divide-gray-800">
            {signals.map(sig => (
              <div class="px-6 py-3 flex items-start gap-3 signal-row" data-signal-type={sig.signalType}>
                <span class="badge bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-400 shrink-0 mt-0.5">{sig.signalType}</span>
                <div class="flex-1 min-w-0">
                  <p class="text-sm text-gray-700 dark:text-gray-300">{sig.signalText}</p>
                  <p class="text-xs text-gray-400 dark:text-gray-500 mt-0.5 font-mono">{sig.id} · {sig.observableId}</p>
                </div>
              </div>
            ))}
          </div>
        </section>
      ))}
    </div>

    <script>
      const buttons = document.querySelectorAll('.signal-filter-btn');
      const rows = document.querySelectorAll('.signal-row');
      const sections = document.querySelectorAll('.signal-section');

      buttons.forEach(btn => {
        btn.addEventListener('click', () => {
          const filter = (btn as HTMLElement).dataset.filter!;

          // Update button states
          buttons.forEach(b => {
            b.classList.remove('bg-blue-100', 'text-blue-700', 'dark:bg-blue-900/40', 'dark:text-blue-300', 'border-blue-300', 'dark:border-blue-700');
            b.classList.add('bg-gray-100', 'text-gray-700', 'dark:bg-gray-700', 'dark:text-gray-300', 'border-transparent');
            b.setAttribute('aria-pressed', 'false');
          });
          btn.classList.remove('bg-gray-100', 'text-gray-700', 'dark:bg-gray-700', 'dark:text-gray-300', 'border-transparent');
          btn.classList.add('bg-blue-100', 'text-blue-700', 'dark:bg-blue-900/40', 'dark:text-blue-300', 'border-blue-300', 'dark:border-blue-700');
          btn.setAttribute('aria-pressed', 'true');

          // Filter rows
          rows.forEach(row => {
            const type = (row as HTMLElement).dataset.signalType;
            if (filter === 'all' || type === filter) {
              (row as HTMLElement).style.display = '';
            } else {
              (row as HTMLElement).style.display = 'none';
            }
          });

          // Hide sections with no visible rows, update counts
          sections.forEach(section => {
            const visibleRows = section.querySelectorAll('.signal-row:not([style*="display: none"])');
            const countEl = section.querySelector('.signal-count');
            if (visibleRows.length === 0) {
              (section as HTMLElement).style.display = 'none';
            } else {
              (section as HTMLElement).style.display = '';
              if (countEl) countEl.textContent = `${visibleRows.length} signals`;
            }
          });
        });
      });
    </script>
  </div>
</BaseLayout>
