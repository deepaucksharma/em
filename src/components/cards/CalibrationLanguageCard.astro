---
import type { CalibrationLanguageEntry } from '../../lib/data';
import { getMetric } from '../../lib/data';
import { url } from '../../lib/url';

interface Props {
  entry: CalibrationLanguageEntry;
}

const { entry } = Astro.props;
const metric = getMetric(entry.metricId);

const contextColors: Record<string, string> = {
  'sprint-review': 'bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300',
  'qbr': 'bg-purple-100 text-purple-700 dark:bg-purple-900/30 dark:text-purple-300',
  'promo-packet': 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-300',
  'budget': 'bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-300',
  'vp-report': 'bg-indigo-100 text-indigo-700 dark:bg-indigo-900/30 dark:text-indigo-300',
  'board': 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-300',
};

const contextLabels: Record<string, string> = {
  'sprint-review': 'Sprint Review',
  'qbr': 'QBR',
  'promo-packet': 'Promo Packet',
  'budget': 'Budget',
  'vp-report': 'VP Report',
  'board': 'Board',
};

const roleColors: Record<string, string> = {
  em: 'bg-cyan-100 text-cyan-700 dark:bg-cyan-900/30 dark:text-cyan-300',
  director: 'bg-orange-100 text-orange-700 dark:bg-orange-900/30 dark:text-orange-300',
};

// Highlight {variables} in template
const highlightedTemplate = entry.template.replace(
  /\{(\w+)\}/g,
  '<span class="px-1 py-0.5 rounded bg-amber-100 dark:bg-amber-900/30 text-amber-700 dark:text-amber-300 font-mono text-xs">{$1}</span>'
);
---

<div class="rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 p-5">
  <div class="flex items-center gap-2 mb-3 flex-wrap">
    <span class:list={['badge text-[10px]', contextColors[entry.context] || contextColors['sprint-review']]}>
      {contextLabels[entry.context] || entry.context}
    </span>
    <span class:list={['badge text-[10px]', roleColors[entry.role] || roleColors.em]}>
      {entry.role.toUpperCase()}
    </span>
    {metric && (
      <a href={url(`/metrics/${metric.slug}/`)} class="text-xs text-blue-600 dark:text-blue-400 hover:underline">
        {metric.name}
      </a>
    )}
  </div>

  <div class="rounded-lg bg-gray-50 dark:bg-gray-900/50 border border-gray-200 dark:border-gray-700 p-4 mb-3">
    <p class="text-sm text-gray-700 dark:text-gray-300 leading-relaxed" set:html={highlightedTemplate} />
  </div>

  <div class="text-xs text-gray-500 dark:text-gray-400 mb-2">
    <strong>When to use:</strong> {entry.whenToUse}
  </div>

  <div class="rounded-lg bg-red-50 dark:bg-red-950/10 border border-red-200 dark:border-red-800 p-3">
    <div class="text-xs font-semibold text-red-600 dark:text-red-400 mb-0.5">Anti-Pattern</div>
    <p class="text-xs text-red-700 dark:text-red-300">{entry.antiPattern}</p>
  </div>
</div>
